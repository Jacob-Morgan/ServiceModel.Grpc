# ServiceModel.Grpc

`ServiceModel.Grpc` enables applications to communicate with gRPC services using code-first approach (no .proto files), helps to get around some limitations of gRPC protocol like "only reference types", "exact one input", "no nulls". Helps to migrate existing WCF solution to gRPC with minimum efforts.

The library supports lightweight runtime proxy generation via Reflection.Emit and C# source code generation.

The solution is built on top of [gRPC C#](https://github.com/grpc/grpc/tree/master/src/csharp).

## Links

- [service and operation names](ServiceAndOperationName.md)
- [service and operation bindings](ServiceAndOperationBinding.md)
- [client configuration](ClientConfiguration.md)
- [client code generation](client-code-generation.md)
- [server code generation](server-code-generation.md)
- [ASP.NET Core server configuration](ASPNETCoreServerConfiguration.md)
- [Grpc.Core server configuration](GrpcCoreServerConfiguration.md)
- error handler general [information](error-handling-general.md)
- global error handling [tutorial](global-error-handling.md)
- getting started [tutorial](CreateClientAndServerASPNETCore.md) create a gRPC client and server
- [compatibility with native gRPC](CompatibilityWithNativegRPC.md)
- migrate from WCF to a gRPC [tutorial](MigrateWCFServiceTogRPC.md)
- migrate from WCF FaultContract to a gRPC global error handling [tutorial](migrate-wcf-faultcontract-to-global-error-handling.md)
- [example](https://github.com/max-ieremenko/ServiceModel.Grpc/tree/master/Examples/ProtobufMarshaller) protobuf marshaller

## Usage

### Declare a service contract

``` c#
[DataContract]
public class Person
{
    [DataMember]
    public string FirstName { get; set; }

    [DataMember]
    public string SecondName { get; set; }
}

[ServiceContract]
public interface IGreeter
{
    [OperationContract]
    Task<string> SayHello(Person person, CancellationToken token = default);
}
```

### Client call (Reflection.Emit)

A proxy for IGreeter service will be generated on demand via `Reflection.Emit`.

```powershell
PS> Install-Package ServiceModel.Grpc
```

``` c#
// create a channel
var channel = new Channel("localhost", 5000, ...);

// create a client factory
var clientFactory = new ClientFactory();

// request the factory to generate a proxy for IGreeter service
var greeter = clientFactory.CreateClient<IGreeter>(channel);

// the call
var greet = await greeter.SayHello(new Person { FirstName = "John", SecondName = "X" });
```

### Client call (source code generation)

A proxy for ICalculator service will be generated in the source code.

```powershell
PS> Install-Package ServiceModel.Grpc.DesignTime
```

``` c#
// request ServiceModel.Grpc to generate a source code for IGreeter service proxy
[ImportGrpcService(typeof(IGreeter))]
internal static partial class MyGrpcServices
{
    // generated code ...
    public static IClientFactory AddGreeterClient(this IClientFactory clientFactory, Action<ServiceModelGrpcClientOptions> configure = null) {}
}

// create a channel
var channel = new Channel("localhost", 5000, ...);

// create a client factory
var clientFactory = new ClientFactory();

// register IGreeter proxy generated by ServiceModel.Grpc.DesignTime
clientFactory.AddGreeterClient();

// create a new instance of the proxy
var greeter = clientFactory.CreateClient<IGreeter>(channel);

// the call
var greet = await greeter.SayHello(new Person { FirstName = "John", SecondName = "X" });
```

> ServiceModel.Grpc.DesignTime uses roslyn [source generators](https://github.com/dotnet/roslyn/blob/master/docs/features/source-generators.md), which requires [net5.0 sdk](https://dotnet.microsoft.com/download/dotnet/5.0).

### Implement a service

``` c#
internal sealed class Greeter : IGreeter
{
    public Task<string> SayHello(Person person, CancellationToken token = default)
    {
        return string.Format("Hello {0} {1}", person.FirstName, person.SecondName);
    }
}
```

### Host the service in asp.net core application

```powershell
PS> Install-Package ServiceModel.Grpc.AspNetCore
```

``` c#
internal sealed class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        // enable ServiceModel.Grpc
        services.AddServiceModelGrpc();
    }

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        app.UseEndpoints(endpoints =>
        {
            // bind Greeter service
            endpoints.MapGrpcService<Greeter>();
        });
    }
}
```

### Host the service in Grpc.Core.Server

```powershell
PS> Install-Package ServiceModel.Grpc.SelfHost
```

``` c#
var server = new Grpc.Core.Server
{
    Ports = { new ServerPort("localhost", 5000, ...) }
};

// bind Greeter service
server.Services.AddServiceModelTransient(() => new Greeter());
```

## Data contracts

By default the DataContractSerializer is used for marshalling data between server an client. This behavior is configurable, see [ProtobufMarshaller example](https://github.com/max-ieremenko/ServiceModel.Grpc/tree/master/Examples/ProtobufMarshaller).

``` c#
[DataContract]
public class Person
{
    [DataMember]
    public string Name { get; set;}

    [DataMember]
    public DateTime BirthDay { get; set;}
}
```

## Service contracts

Service contract is a public interface marked with ServiceContractAttribute.
Methods marked with OperationContractAttribute are gRPC calls.

> for net461 System.ServiceModel.dll, for netstandard package System.ServiceModel.Primitives

``` c#
[ServiceContract]
public interface IPersonService
{
    // gRPC call
    [OperationContract]
    Task Ping();

    // method is not gRPC call
    Task Ping();
}
```

## Operation contracts

Any operation in a service contract is one of gRPC method: Unary, ClientStreaming, ServerStreaming or DuplexStreaming.

#### Unary operation

Response is optional, any number of request parameters

``` c#
// blocking unary client call
[OperationContract]
int Sum(int x, int y);

// async unary client call
[OperationContract]
Task<string> SumAsync(int x, int y);
```

#### ClientStreaming operation

Response is optional

``` c#
// call is compatible with native gRPC
[OperationContract]
Task<long> SumValues(IAsyncEnumerable<int> values);
```

ServiceModel.Grpc supports any number of extra request parameters, but this call is not fully compatible with native gRPC call.

``` c#
// call is not fully compatible with native gRPC
[OperationContract]
Task<long> MultiplyByAndSumValues(IAsyncEnumerable<int> values, int multiplier);
```

#### ServerStreaming operation

Any number of request parameters

``` c#
[OperationContract]
IAsyncEnumerable<int> EnumerableRange(int start, int count);

[OperationContract]
Task<IAsyncEnumerable<int>> EnumerableRange(int start, int count);
```

#### DuplexStreaming operation

``` c#
// call is compatible with native gRPC
[OperationContract]
IAsyncEnumerable<int> MultiplyBy2(IAsyncEnumerable<int> values);

// call is compatible with native gRPC
[OperationContract]
Task<IAsyncEnumerable<int>> MultiplyBy2(IAsyncEnumerable<int> values);
```

ServiceModel.Grpc supports any number of extra request parameters, but this call is not fully compatible with native gRPC call.

``` c#
// call is not fully compatible with native gRPC
[OperationContract]
IAsyncEnumerable<int> MultiplyBy(IAsyncEnumerable<int> values, int multiplier);

// call is not fully compatible with native gRPC
[OperationContract]
Task<IAsyncEnumerable<int>> MultiplyBy(IAsyncEnumerable<int> values, int multiplier);
```

#### Context parameters

ServiceModel.Grpc.CallContext

``` c#
// contract
[OperationContract]
Task Ping(CallContext context = default);

// client
await client.Ping(new CallOptions(....));

// server
Task Ping(CallContext context)
{
    // take ServerCallContext
    Grpc.Core.ServerCallContext serverContext = context;
    var token = serverContext.CancellationToken;
    var requestHeaders = serverContext.RequestHeaders;
}
```

Grpc.Core.CallOptions

``` c#
// contract
[OperationContract]
Task Ping(CallOptions context = default);

// client
await client.Ping(new CallOptions(....));

// server
Task Ping(CallOptions context)
{
    // context is not available here (default)
}
```

Grpc.Core.ServerCallContext

``` c#
// contract
[OperationContract]
Task Ping(ServerCallContext context = default);

// client
await client.Ping();

// server
Task Ping(ServerCallContext context)
{
    var token = context.CancellationToken;
    var requestHeaders = context.RequestHeaders;
}
```

System.Threading.CancellationToken

``` c#
// contract
[OperationContract]
Task Ping(CancellationToken token = default);

// client
var tokenSource = new CancellationTokenSource();
await client.Ping(tokenSource.Token);

// server
Task Ping(CancellationToken token)
{
    if (!token.IsCancellationRequested)
    {
        // ...
    }
}
```

## Limitations

- generic methods are not supported
- ref and out parameters are not supported
